@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthStateProvider
@inject AuthService Auth
@inject ExpenseService ExpenseService
@inject NavigationManager NavigationManager
@inject DollarValues DollarValues
@page "/"
@using System.Globalization

<AuthorizeView>
    <Authorized>
        <div class="wrapper">
            <div class="d-flex align-items-center justify-content-between mb-4">
                <div>
                    <h2 class="h2 fw-bolder">Dashboard</h2>
                    <p class="small text-muted">Overview of your expenses</p>
                </div>
                <div>
                    <button class="btn btn-primary" @onclick="New">Add New Expense</button>
                    <button class="btn btn-danger ms-2" @onclick="Logout">Logout</button>
                    <button class="btn btn-sm btn-secondary ms-2" onclick="toggleDataBsTheme()"><i class="bi bi-palette"></i></button>
                </div>
            </div>
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <div class="card p-3">
                        <div class="small text-muted">Total ARS$</div>
                        <div class="h5 fw-bold">@total.ToString("C")</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card p-3">
                        <div class="small text-muted">Total USD$</div>
                        <div class="h5 text-success fw-bold">@FormatUsd(totalUsd)</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card p-3">
                        <div class="small text-muted">This month</div>
                        <div class="h5 fw-bold">@monthTotal.ToString("C")</div>
                    </div>
                </div>
            </div>
            <div class="mb-3 d-flex flex-wrap gap-2 align-items-center">
                <div class="flex-fill" style="min-width:200px;">
                    <input type="text" placeholder="Search expenses..." class="form-control" value="@searchText" @oninput="@(e => { searchText = e.Value?.ToString() ?? string.Empty; FilterExpenses(); })" />
                </div>
                <div>
                    <select class="form-select w-auto" value="@selectedEntityType" @onchange="@(e => { selectedEntityType = e.Value?.ToString() ?? string.Empty; FilterExpenses(); })">
                        <option value="">All Entities</option>
                        <option value="Bank">Banks</option>
                        <option value="DigitalWallet">Digital Wallets</option>
                    </select>
                </div>
                <div>
                    <select class="form-select w-auto" value="@(selectedMonth?.ToString() ?? string.Empty)" @onchange="@(e => { selectedMonth = string.IsNullOrEmpty(e.Value?.ToString()) ? null : int.Parse(e.Value.ToString()!); FilterExpenses(); })">
                        <option value="">All Months</option>
                        @for (int i = 1; i <= 12; i++)
                        {
                            <option value="@i">@(new DateTime(2000, i, 1).ToString("MMMM"))</option>
                        }
                    </select>
                </div>
                <div>
                    <select class="form-select w-auto" value="@(selectedYear?.ToString() ?? string.Empty)" @onchange="@(e => { selectedYear = string.IsNullOrEmpty(e.Value?.ToString()) ? null : int.Parse(e.Value.ToString()!); FilterExpenses(); })">
                        <option value="">All Years</option>
                        @foreach (var year in availableYears)
                        {
                            <option value="@year">@year</option>
                        }
                    </select>
                </div>
                <div>
                    <input type="date" class="form-control" value="@(selectedStartDate?.ToString("yyyy-MM-dd") ?? string.Empty)" @onchange="@(e => { selectedStartDate = string.IsNullOrEmpty(e.Value?.ToString()) ? null : DateTime.Parse(e.Value.ToString()!); FilterExpenses(); })" />
                </div>
                <div>
                    <input type="date" class="form-control" value="@(selectedEndDate?.ToString("yyyy-MM-dd") ?? string.Empty)" @onchange="@(e => { selectedEndDate = string.IsNullOrEmpty(e.Value?.ToString()) ? null : DateTime.Parse(e.Value.ToString()!); FilterExpenses(); })" />
                </div>
                <div>
                    <button class="btn btn-secondary border" @onclick="ClearFilters">Clear Filters</button>
                </div>
            </div>
            <div class="card">
                @if (filteredExpenses == null || !filteredExpenses.Any())
                {
                    <div class="p-4 text-center">
                        <img src="img/error.gif" alt="No records found" class="mb-3" style="max-width:16rem;" />
                        <p class="text-muted">No expenses found</p>
                        @if (!string.IsNullOrEmpty(searchText) || !string.IsNullOrEmpty(selectedEntityType) || selectedMonth.HasValue || selectedYear.HasValue || selectedStartDate.HasValue || selectedEndDate.HasValue)
                        {
                            <p class="small text-muted mt-2">Try adjusting your filters</p>
                            <button class="btn btn-outline-primary mt-3" @onclick="ClearFilters">Clear All Filters</button>
                        }
                    </div>
                }
                else
                {
                    <table class="table mb-0">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>ARS$</th>
                                <th>USD$</th>
                                <th>USDRate</th>
                                <th>Date</th>
                                <th>Entity</th>
                                <th>Payment Method</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var e in filteredExpenses)
                            {
                                <tr>
                                    <td class="text-truncate" style="max-width:200px;">@e.Title</td>
                                    <td>@GetArsValue(e).ToString("C")</td>
                                    <td class="text-success">@FormatUsd(GetUsdValue(e))</td>
                                    <td>@(e.USDRate <= 0 ? "-" : e.USDRate.ToString("N2"))</td>
                                    <td>@e.Date.ToShortDateString()</td>
                                    <td class="text-truncate" style="max-width:200px;">@if (e.FinancialEntity != null)
                                        {
                                            <span>@e.FinancialEntity.Name (@e.FinancialEntity.Type)</span>
                                        }
                                    </td>
                                    <td>
                                        @if (e.IsPaid)
                                        {
                                            <span class="badge bg-success">Paid</span>
                                        }
                                        else if (e.IsTransferred)
                                        {
                                            <span class="badge bg-primary">Transferred</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning text-dark">Pending</span>
                                        }
                                    </td>
                                    <td>
                                        <button class="btn btn-link text-decoration-none text-primary me-2" @onclick="() => Edit(e.Id)">‚úèÔ∏è</button>
                                        <button class="btn btn-link text-decoration-none text-danger" @onclick="() => Delete(e.Id)">üóëÔ∏è</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
            @if (showModal)
            {
                <ExpenseModal Expense="editing" OnClose="CloseModal" OnSaved="Reload" />
            }
        </div>
    </Authorized>
    <NotAuthorized>
        <div class="mx-auto mt-5 text-center" style="max-width:28rem;">
            <img src="img/home.gif" alt="login" class="mb-3 img-fluid" />
            <div class="alert alert-warning text-start">
                <p class="fw-bold mb-1">Warning</p>
                <p class="mb-0">You must <a href="/login">login</a> to view your dashboard.</p>
            </div>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    List<ExpensesTracker.Data.Expense>? expenses;
    List<ExpensesTracker.Data.Expense>? filteredExpenses;
    decimal total = 0;
    decimal totalUsd = 0;
    decimal monthTotal = 0;
    bool showModal = false;
    ExpensesTracker.Data.Expense? editing;
    int currentUserId;
    string searchText = string.Empty;
    string selectedEntityType = string.Empty;
    int? selectedMonth = null;
    int? selectedYear = null;
    List<int> availableYears = new();
    decimal DollarPrice { get; set; }

    // Custom date range filters
    DateTime? selectedStartDate = null;
    DateTime? selectedEndDate = null;

    // Return a safe (non-zero) dollar price to avoid division by zero
    decimal SafeDollarPrice => DollarPrice <= 0 ? 1m : DollarPrice;

    // Compute ARS value for an expense. If StoredCurrency == 1 (USD), convert to ARS using USDRate.
    decimal GetArsValue(ExpensesTracker.Data.Expense e)
    {
        var rate = e.USDRate <= 0 ? 1m : e.USDRate;
        return e.StoredCurrency == 1 ? e.Amount * rate : e.Amount;
    }

    // Compute USD value for an expense. If StoredCurrency == 1 (USD), amount is already USD.
    decimal GetUsdValue(ExpensesTracker.Data.Expense e)
    {
        var rate = e.USDRate <= 0 ? 1m : e.USDRate;
        return e.StoredCurrency == 1 ? e.Amount : e.Amount / rate;
    }

    // Formats an ARS amount as USD using the current DollarPrice safely.
    string ToUsdDisplay(decimal arsAmount, decimal usdRate)
    {
        try
        {
            var safe = usdRate <= 0 ? 1m : usdRate;
            var usd = arsAmount / safe;
            // Use invariant culture and USD currency symbol for consistency
            return usd.ToString("C", CultureInfo.CreateSpecificCulture("en-US"));
        }
        catch
        {
            // Fallback in the unlikely event of an error
            return "$0.00";
        }
    }

    string FormatUsd(decimal usdValue)
    {
        return usdValue.ToString("C", CultureInfo.CreateSpecificCulture("en-US"));
    }

    protected override async Task OnInitializedAsync()
    {
        await DollarValues.GetLastDollarValues();
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            currentUserId = int.Parse(user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)!.Value);
            DollarPrice = (DollarValues.PriceBuy + DollarValues.PriceSell) / 2;
            await Load();
        }
    }

    private void FilterExpenses()
    {
        filteredExpenses = expenses;

        if (!string.IsNullOrWhiteSpace(searchText))
        {
            filteredExpenses = filteredExpenses?
            .Where(e => e.Title.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                   (e.FinancialEntity?.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false))
            .ToList();
        }

        if (!string.IsNullOrWhiteSpace(selectedEntityType))
        {
            var type = Enum.Parse<EntityType>(selectedEntityType);
            filteredExpenses = filteredExpenses?
                .Where(e => e.FinancialEntity?.Type == type)
                .ToList();
        }

        if (selectedMonth.HasValue)
        {
            filteredExpenses = filteredExpenses?
                .Where(e => e.Date.Month == selectedMonth.Value)
                .ToList();
        }

        if (selectedYear.HasValue)
        {
            filteredExpenses = filteredExpenses?
                .Where(e => e.Date.Year == selectedYear.Value)
                .ToList();
        }

        // Apply custom date range if present (inclusive)
        if (selectedStartDate.HasValue)
        {
            var s = selectedStartDate.Value.Date;
            filteredExpenses = filteredExpenses?
                .Where(e => e.Date.Date >= s)
                .ToList();
        }

        if (selectedEndDate.HasValue)
        {
            var eDate = selectedEndDate.Value.Date;
            filteredExpenses = filteredExpenses?
                .Where(e => e.Date.Date <= eDate)
                .ToList();
        }

        // Recalculate totals based on the filtered list so the UI reflects active filters
        total = filteredExpenses?.Sum(e => GetArsValue(e)) ?? 0;
        totalUsd = filteredExpenses?.Sum(e => GetUsdValue(e)) ?? 0;
        var now = DateTime.Now;
        monthTotal = filteredExpenses?.Where(e => e.Date.Year == now.Year && e.Date.Month == now.Month).Sum(e => GetArsValue(e)) ?? 0;

        StateHasChanged();
    }

    private void ClearFilters()
    {
        searchText = string.Empty;
        selectedEntityType = string.Empty;
        selectedMonth = null;
        selectedYear = null;
        selectedStartDate = null;
        selectedEndDate = null;
        FilterExpenses();
    }

    async Task Load()
    {
        expenses = await ExpenseService.GetByUserAsync(currentUserId);
        // Update available years list
        availableYears = expenses?
            .Select(e => e.Date.Year)
            .Distinct()
            .OrderByDescending(y => y)
            .ToList() ?? new List<int>();
        // Apply filters (which also recalculates totals)
        FilterExpenses();
        StateHasChanged();
    }

    void New()
    {
        editing = new ExpensesTracker.Data.Expense { Date = DateTime.Now, UserId = currentUserId };
        showModal = true;
    }

    async Task Edit(int id)
    {
        editing = await ExpenseService.GetAsync(id);
        showModal = true;
    }

    async Task Delete(int id)
    {
        await ExpenseService.DeleteAsync(id);
        await Load();
    }

    async Task CloseModal()
    {
        showModal = false;
        editing = null;
        await Load();
    }

    async Task Reload()
    {
        showModal = false;
        await Load();
    }

    async Task Logout()
    {
        await Auth.LogoutAsync();
        if (AuthStateProvider is ExpensesTracker.Services.SimpleAuthStateProvider sap) sap.NotifyAuthChanged();
        NavigationManager.NavigateTo("/login");
    }
}